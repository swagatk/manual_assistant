<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="/__/firebase/9.17.1/firebase-app-compat.js"></script>
    <script src="/__/firebase/9.17.1/firebase-auth-compat.js"></script>
    <script src="/__/firebase/9.17.1/firebase-firestore-compat.js"></script>
    <script src="/__/firebase/9.17.1/firebase-storage-compat.js"></script>
    <script src="/__/firebase/9.17.1/firebase-functions-compat.js"></script>
    <script src="/__/firebase/init.js"></script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .file-item-selected { background-color: #3b82f6 !important; color: white !important; }
        .typing-indicator span { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .modal { transition: opacity 0.3s ease; }
        .feedback-btn.selected svg { fill: currentColor; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased">

    <!-- Authentication Container -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-lg shadow-lg">
            <h1 class="text-3xl font-bold text-center text-white mb-2">Manual Assistant</h1>
            <p id="auth-mode-label" class="text-center text-gray-400 mb-6">Please log in to continue</p>
            
            <div id="auth-notice" class="bg-blue-500/20 text-blue-200 text-sm p-3 rounded-lg mb-4 hidden"></div>
            <div id="auth-error" class="bg-red-500/20 text-red-300 text-sm p-3 rounded-lg mb-4 hidden"></div>

            <form id="auth-form">
                <div class="mb-4">
                    <label for="email-input" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" id="email-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" required>
                </div>
                <div class="mb-6">
                    <label for="password-input" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" id="password-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" required>
                </div>
                <button type="submit" id="main-auth-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">Login</button>
            </form>
            <p id="auth-prompt-text" class="text-center text-sm text-gray-400 mt-6">
                Don't have an account? <a href="#" id="toggle-auth-mode" class="font-medium text-blue-400 hover:underline">Sign up</a>
            </p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="hidden h-screen">
        <!-- Settings Modal -->
        <div id="settings-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
             <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-md mx-4">
                <h2 class="text-2xl font-bold text-white mb-6">Settings</h2>
                <form id="settings-form">
                    <div class="mb-4">
                        <label for="api-key-input" class="block text-sm font-medium text-gray-300 mb-1">Gemini API Key</label>
                        <input type="password" id="api-key-input" placeholder="Paste your API key here" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                         <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-blue-400 hover:underline mt-1 inline-block">Get a Free API Key &rarr;</a>
                    </div>
                    <div class="mb-6">
                        <label for="operator-email-input" class="block text-sm font-medium text-gray-300 mb-1">Operator Email for Escalation</label>
                        <input type="email" id="operator-email-input" placeholder="expert@example.com" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                    </div>
                    <div class="mb-6">
                        <label for="model-name-input" class="block text-sm font-medium text-gray-300 mb-1">Gemini Model Name</label>
                        <input type="text" id="model-name-input" placeholder="e.g., gemini-1.5-pro-latest" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white">
                    </div>
                    <div class="flex justify-between items-center">
                        <button type="button" id="close-settings-modal" class="text-gray-400 hover:text-white">Cancel</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Analytics Modal -->
        <div id="analytics-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
             <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl mx-4 max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Feedback Analytics</h2>
                    <button id="close-analytics-modal" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <div id="analytics-content" class="overflow-y-auto"></div>
            </div>
        </div>

        <!-- User Management Modal -->
        <div id="users-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
             <div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-3xl mx-4 max-h-[80vh] flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-white">Manage Users</h2>
                    <button id="close-users-modal" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
                </div>
                <p class="text-xs text-gray-400 mb-4">Disable accounts to temporarily revoke access, or delete to remove them entirely. You cannot disable or delete your own account.</p>
                <div id="users-content" class="overflow-y-auto divide-y divide-gray-700"></div>
             </div>
        </div>

        <div class="flex h-full">
            <!-- Left Panel -->
            <div class="w-1/3 bg-gray-800 p-6 flex flex-col border-r border-gray-700">
                <header class="mb-6 flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-white">Manual Assistant</h1>
                        <p id="welcome-message" class="text-sm text-gray-400">Welcome!</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="analytics-button" class="admin-only" title="View Analytics">
                           <svg class="w-6 h-6 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                        </button>
                                <button id="manage-users-button" class="admin-only" title="Manage Users">
                                    <svg class="w-6 h-6 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a4 4 0 00-3-3.87M9 11a4 4 0 100-8 4 4 0 000 8zm6 9v-2a4 4 0 00-3-3.87m6-5.63a4 4 0 11-8 0 4 4 0 018 0zM3 20h6m-3-3a4 4 0 00-3 3"></path></svg>
                                </button>
                        <button id="settings-button" class="admin-only" title="Settings">
                           <svg class="w-6 h-6 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                        <button id="logout-button" title="Logout">
                           <svg class="w-6 h-6 text-gray-400 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        </button>
                    </div>
                </header>
                
                <div id="upload-zone" class="admin-only border-2 border-dashed border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-blue-500 hover:bg-gray-700 transition-colors">
                    <input type="file" id="pdf-upload" class="hidden" accept=".pdf" multiple>
                    <label for="pdf-upload" class="cursor-pointer">
                       <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                        <p class="mt-2 text-sm text-gray-400"><span class="font-semibold text-blue-400">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-gray-500">PDF files only (Admin)</p>
                    </label>
                </div>

                <div id="processing-indicator" class="hidden mt-4 text-center p-4 bg-gray-700 rounded-lg">
                    <p id="processing-filename" class="text-sm text-blue-400 font-semibold truncate">Processing file...</p>
                    <p id="processing-pages" class="text-xs text-gray-400 mt-1"></p>
                    <div class="w-full bg-gray-600 rounded-full h-2.5 mt-2">
                        <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <div class="mt-6 flex-grow overflow-y-auto">
                    <h2 class="text-lg font-semibold text-gray-300 mb-2">Available Manuals</h2>
                    <ul id="file-list" class="space-y-2">
                        <li id="no-files-message" class="text-gray-500 text-sm">No manuals available. An admin needs to upload them.</li>
                    </ul>
                </div>
            </div>
            <!-- Right Panel -->
            <div class="w-2/3 flex flex-col bg-gray-900">
                <header id="chat-header" class="p-4 border-b border-gray-800 text-center"><h2 class="text-xl font-semibold">Select a manual to start chatting</h2></header>
                <main id="chat-window" class="flex-grow p-6 overflow-y-auto"><div id="chat-messages" class="space-y-4"></div></main>
                <footer id="chat-footer" class="p-4 border-t border-gray-800">
                    <form id="chat-form" class="flex items-center space-x-4">
                        <input type="text" id="chat-input" placeholder="Ask a question..." class="flex-grow bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white disabled:opacity-50" disabled>
                        <button type="submit" id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                           <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        </button>
                    </form>
                </footer>
            </div>
        </div>
    </div>





    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase
            const auth = firebase.auth();
            const db = firebase.firestore();
            const storage = firebase.storage();
            const functions = firebase.functions();

            // Enable offline persistence
            (async () => {
                try {
                    await db.enablePersistence();
                } catch (err) {
                    if (err.code == 'failed-precondition') {
                        console.warn("Multiple tabs open, persistence can only be enabled in one tab at a time.");
                    } else if (err.code == 'unimplemented') {
                        console.warn("The current browser does not support all of the features required to enable persistence.");
                    }
                }
            })();

            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');

            // Check if the user is authenticated
            auth.onAuthStateChanged(async (user) => {
                authError.classList.add('hidden');

                if (!user) {
                    state.user = null;
                    state.isAdmin = false;
                    state.isApproved = false;
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    return;
                }

                state.user = user;

                try {
                    const idTokenResult = await user.getIdTokenResult(true);
                    const claims = idTokenResult.claims || {};
                    state.isAdmin = !!claims.admin;
                    state.isApproved = state.isAdmin || claims.approved === true;

                    if (!state.isApproved) {
                        authContainer.classList.remove('hidden');
                        appContainer.classList.add('hidden');
                        authNotice.textContent = 'Your account is pending administrator approval. You will receive access once an admin approves your registration.';
                        authNotice.classList.remove('hidden');
                        await auth.signOut();
                        return;
                    }

                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    authNotice.classList.add('hidden');

                    welcomeMessage.textContent = `Welcome, ${user.email}`;
                    updateRoleUI();
                    fetchSettings();
                    listenForManuals();
                    setupAdminFileUpload();
                    if (state.isAdmin) {
                        listenForAnalytics();
                    }
                } catch (error) {
                    console.error('Failed to load user claims:', error);
                    authError.textContent = 'Unable to verify your account. Please try signing in again.';
                    authError.classList.remove('hidden');
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    await auth.signOut();
                }
            });

            const authForm = document.getElementById('auth-form');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const mainAuthBtn = document.getElementById('main-auth-btn');
            const authError = document.getElementById('auth-error');
            const authNotice = document.getElementById('auth-notice');
            const logoutButton = document.getElementById('logout-button');
            const welcomeMessage = document.getElementById('welcome-message');
            const toggleAuthModeLink = document.getElementById('toggle-auth-mode');
            const authModeLabel = document.getElementById('auth-mode-label');
            const authPromptText = document.getElementById('auth-prompt-text');
            
            const uploadZone = document.getElementById('upload-zone');
            const pdfUpload = document.getElementById('pdf-upload');
            const fileList = document.getElementById('file-list');
            const noFilesMessage = document.getElementById('no-files-message');
            const processingIndicator = document.getElementById('processing-indicator');
            const progressBar = document.getElementById('progress-bar');
            const processingFilename = document.getElementById('processing-filename');
            const processingPages = document.getElementById('processing-pages');
            
            const chatHeader = document.getElementById('chat-header');
            const chatWindow = document.getElementById('chat-window');
            const chatMessages = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            
            const settingsModal = document.getElementById('settings-modal');
            const settingsForm = document.getElementById('settings-form');
            const apiKeyInput = document.getElementById('api-key-input');
            const operatorEmailInput = document.getElementById('operator-email-input');
            const modelNameInput = document.getElementById('model-name-input');
            const settingsButton = document.getElementById('settings-button');
            const closeSettingsModal = document.getElementById('close-settings-modal');
            
            const analyticsModal = document.getElementById('analytics-modal');
            const analyticsButton = document.getElementById('analytics-button');
            const closeAnalyticsModal = document.getElementById('close-analytics-modal');
            const analyticsContent = document.getElementById('analytics-content');

            const manageUsersButton = document.getElementById('manage-users-button');
            const usersModal = document.getElementById('users-modal');
            const closeUsersModal = document.getElementById('close-users-modal');
            const usersContent = document.getElementById('users-content');
            
            pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

            let isLoginMode = true;

            let state = {
                user: null,
                isAdmin: false,
                isApproved: false,
                manuals: {},
                aggregateManualText: "",
                currentManual: null,
                currentQuery: "",
                isProcessing: false,
                isAwaitingResponse: false,
                settings: { apiKey: "", operatorEmail: "", model: "" },
                unsubscribeManuals: null,
                unsubscribeAnalytics: null,
                users: [],
            };

            function formatTimestamp(timestamp) {
                if (!timestamp) return 'Never';
                const date = new Date(timestamp);
                if (Number.isNaN(date.getTime())) return 'Unknown';
                return date.toLocaleString();
            }

            document.body.addEventListener('click', (e) => {
                if (e.target.id === 'toggle-auth-mode') {
                    e.preventDefault();
                    isLoginMode = !isLoginMode;
                    authError.classList.add('hidden');
                    authNotice.classList.add('hidden');
                    if (isLoginMode) {
                        authModeLabel.textContent = 'Please log in to continue';
                        mainAuthBtn.textContent = 'Login';
                        authPromptText.innerHTML = `Don't have an account? <a href="#" id="toggle-auth-mode" class="font-medium text-blue-400 hover:underline">Sign up</a>`;
                    } else {
                        authModeLabel.textContent = 'Create a new account';
                        mainAuthBtn.textContent = 'Sign Up';
                        authPromptText.innerHTML = `Already have an account? <a href="#" id="toggle-auth-mode" class="font-medium text-blue-400 hover:underline">Login</a>`;
                    }
                }
            });

            authForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                mainAuthBtn.disabled = true;
                mainAuthBtn.textContent = 'Connecting...';
                const email = emailInput.value;
                const password = passwordInput.value;
                authError.classList.add('hidden');
                authNotice.classList.add('hidden');

                try {
                    if (isLoginMode) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        await auth.createUserWithEmailAndPassword(email, password);
                        authNotice.textContent = 'Registration received. Please wait for an administrator to approve your account.';
                        authNotice.classList.remove('hidden');
                    }
                    // onAuthStateChanged will handle the UI update
                } catch (error) {
                    console.error('Auth Error:', error);
                    authError.textContent = error.message;
                    authError.classList.remove('hidden');
                } finally {
                    mainAuthBtn.disabled = false;
                    mainAuthBtn.textContent = isLoginMode ? 'Login' : 'Sign Up';
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    // onAuthStateChanged will handle the UI update
                } catch (error) {
                    console.error('Logout Error:', error);
                }
            });
            
            async function getDocWithRetry(docRef, retries = 3, delay = 1000) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const docSnap = await docRef.get();
                        return docSnap;
                    } catch (error) {
                        if ((error.code === 'unavailable' || error.message.includes('offline')) && i < retries - 1) {
                            console.warn(`(Attempt ${i + 1}) Connection issue fetching doc, retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                        } else {
                            throw error;
                        }
                    }
                }
            }
            

            
            function updateRoleUI() {
                const adminOnlyElements = document.querySelectorAll('.admin-only');
                adminOnlyElements.forEach(el => {
                    el.style.display = state.isAdmin ? '' : 'none';
                });
            }
            
            async function fetchSettings() {
                if (!state.isAdmin) return;
                const settingsDocRef = db.collection('settings').doc('config');
                try {
                    const docSnap = await getDocWithRetry(settingsDocRef);
                    if (docSnap.exists) {
                        state.settings = docSnap.data();
                    }
                } catch (error) {
                    console.error("Error fetching settings:", error);
                    addMessage('system', 'Could not load settings from the database.');
                }
                apiKeyInput.value = state.settings.apiKey || '';
                operatorEmailInput.value = state.settings.operatorEmail || '';
                modelNameInput.value = state.settings.model || '';
            }

            settingsButton.addEventListener('click', () => settingsModal.classList.remove('hidden'));
            closeSettingsModal.addEventListener('click', () => settingsModal.classList.add('hidden'));

            settingsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!state.isAdmin) return;

                try {
                    const apiKey = apiKeyInput.value.trim();
                    const operatorEmail = operatorEmailInput.value.trim();
                    const model = modelNameInput.value.trim();
                    
                    const settingsDocRef = db.collection('settings').doc('config');
                    await settingsDocRef.set({ apiKey, operatorEmail, model }, { merge: true });
                    
                    state.settings.apiKey = apiKey;
                    state.settings.operatorEmail = operatorEmail;
                    state.settings.model = model;

                    addMessage('system', 'Settings saved successfully.');
                } catch (error) {
                    console.error("Error saving settings:", error);
                    addMessage('system', 'Error: Could not save settings.');
                } finally {
                    settingsModal.classList.add('hidden');
                }
            });

            function setupAdminFileUpload() {
                if (!uploadZone) return;
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadZone.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadZone.addEventListener(eventName, () => uploadZone.classList.add('bg-gray-700', 'border-blue-500'), false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('bg-gray-700', 'border-blue-500'), false);
                });
                uploadZone.addEventListener('click', () => {
                    if (state.isAdmin && !state.isProcessing) {
                        pdfUpload.click();
                    }
                });
                uploadZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);
                pdfUpload.addEventListener('change', (e) => handleFiles(e.target.files));
            }

            async function handleFiles(files) {
                if (!state.isAdmin || state.isProcessing) return;
                console.log('handleFiles called with', files);
                const incomingFiles = Array.from(files || []);
                if (incomingFiles.length === 0) return;

                const pdfFiles = incomingFiles.filter(file => file.type === 'application/pdf');
                if (pdfFiles.length === 0) {
                    addMessage('system', 'Please choose PDF files to upload.');
                    return;
                }

                state.isProcessing = true;
                processingIndicator.classList.remove('hidden');

                for (const file of pdfFiles) {
                    try {
                        processingFilename.textContent = `Processing: ${file.name}`;
                        progressBar.style.width = '0%';
                        
                        console.log('Starting upload for', file.name);
                        const storageRef = storage.ref(`manuals/${file.name}`);
                        const uploadTask = storageRef.put(file);

                        await new Promise((resolve, reject) => {
                            uploadTask.on('state_changed',
                                (snapshot) => {
                                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                    console.log('Upload progress:', progress);
                                    progressBar.style.width = progress + '%';
                                    processingPages.textContent = `Uploading: ${Math.round(progress)}%`;
                                },
                                (error) => {
                                    console.error("Upload error:", error);
                                    let errorMessage = `Upload failed for ${file.name}. `;
                                    switch (error.code) {
                                        case 'storage/unauthorized':
                                            errorMessage += 'Permission denied. Please check your Firebase Storage security rules in the console.';
                                            break;
                                        case 'storage/retry-limit-exceeded':
                                            errorMessage += 'Connection timed out. Please check your internet connection and try again.';
                                            break;
                                        default:
                                            errorMessage += 'An unknown error occurred.';
                                            break;
                                    }
                                    addMessage('system', errorMessage);
                                    reject(error);
                                },
                                () => {
                                    console.log('Upload complete for', file.name);
                                    resolve(); // Upload completed successfully
                                }
                            );
                        });
                        
                        const fileReader = new FileReader();
                        const arrayBuffer = await new Promise((resolve, reject) => {
                            fileReader.onload = () => resolve(fileReader.result);
                            fileReader.onerror = reject;
                            fileReader.readAsArrayBuffer(file);
                        });

                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            processingPages.textContent = `Extracting text from page ${i} of ${pdf.numPages}`;
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                            progressBar.style.width = `${(i / pdf.numPages) * 100}%`;
                        }

                        processingPages.textContent = 'Saving to database...';
                        await db.collection("manuals").doc(file.name).set({
                            name: file.name,
                            textContent: fullText
                        });

                    } catch (error) {
                        if (error.code && !error.code.startsWith('storage/')) {
                             addMessage('system', `Failed to process ${file.name} after upload.`);
                        }
                    }
                }
                pdfUpload.value = '';
                state.isProcessing = false;
                processingIndicator.classList.add('hidden');
                processingFilename.textContent = 'Processing file...';
                processingPages.textContent = '';
            }

            function listenForManuals() {
                if (state.unsubscribeManuals) state.unsubscribeManuals();
                const q = db.collection("manuals");
                state.unsubscribeManuals = q.onSnapshot((snapshot) => {
                    fileList.innerHTML = '';
                    state.manuals = {};
                    const manualEntries = [];

                    if (snapshot.empty) {
                        state.aggregateManualText = '';
                        state.currentManual = null;
                        fileList.appendChild(noFilesMessage);
                        updateChatUI();
                        return;
                    }

                    const baseItemClasses = 'manual-list-item p-3 rounded-lg cursor-pointer hover:bg-gray-600 transition-colors text-sm flex items-center justify-between space-x-2';

                    const createListItem = (manualKey, label, allowDelete = false) => {
                        const li = document.createElement('li');
                        li.dataset.manual = manualKey;
                        li.className = baseItemClasses;
                        if (state.currentManual === manualKey) {
                            li.classList.add('file-item-selected');
                        } else {
                            li.classList.add('bg-gray-700');
                        }

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'truncate';
                        nameSpan.textContent = label;
                        li.appendChild(nameSpan);

                        if (allowDelete && state.isAdmin) {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.type = 'button';
                            deleteBtn.className = 'delete-manual-btn text-xs text-red-400 hover:text-red-200 focus:outline-none';
                            deleteBtn.title = `Delete ${label}`;
                            deleteBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
                            deleteBtn.addEventListener('click', async (event) => {
                                event.stopPropagation();
                                if (!confirm(`Delete "${label}"? This removes the manual from storage and future chats.`)) {
                                    return;
                                }
                                deleteBtn.disabled = true;
                                try {
                                    await deleteManual(manualKey);
                                } finally {
                                    deleteBtn.disabled = false;
                                }
                            });
                            li.appendChild(deleteBtn);
                        }

                        li.addEventListener('click', () => selectManual(manualKey));
                        fileList.appendChild(li);
                    };

                    createListItem('__ALL__', 'All Manuals');

                    snapshot.forEach(doc => {
                        const manual = doc.data();
                        if (!manual || !manual.name || !manual.textContent) return;
                        state.manuals[manual.name] = manual.textContent;
                        manualEntries.push(manual);
                        createListItem(manual.name, manual.name, true);
                    });

                    state.aggregateManualText = manualEntries
                        .map(entry => `Manual: ${entry.name}\n\n${entry.textContent}`)
                        .join('\n\n-----\n\n');

                    const manualExists =
                        state.currentManual && (state.currentManual === '__ALL__' || state.manuals[state.currentManual]);

                    if (!manualExists) {
                        selectManual('__ALL__');
                    } else {
                        highlightManual(state.currentManual);
                    }

                    updateChatUI();
                }, (error) => {
                    console.error("Error listening for manuals:", error);
                    addMessage('system', "Could not load manuals.");
                });
            }
            
            function selectManual(manualKey) {
                if (state.currentManual === manualKey) return;
                state.currentManual = manualKey;
                chatMessages.innerHTML = '';
                if (manualKey === '__ALL__') {
                    addMessage('assistant', { short: 'Ready to answer questions across all uploaded manuals.' });
                } else {
                    addMessage('assistant', { short: `Ready to answer questions about <strong>${manualKey}</strong>.` });
                }
                updateChatUI();
                highlightManual(manualKey);
            }

            function highlightManual(manualKey) {
                const listItems = fileList.querySelectorAll('li[data-manual]');
                listItems.forEach(li => {
                    const isActive = li.dataset.manual === manualKey;
                    li.classList.toggle('file-item-selected', isActive);
                    li.classList.toggle('bg-gray-700', !isActive);
                });
            }

            async function deleteManual(manualName) {
                if (!state.isAdmin) {
                    addMessage('system', 'Only administrators can delete manuals.');
                    return false;
                }

                const manualDocRef = db.collection("manuals").doc(manualName);
                try {
                    await manualDocRef.delete();
                } catch (error) {
                    console.error("Firestore delete error:", error);
                    addMessage('system', `Could not remove ${manualName} from the manuals list. ${error.message || ''}`);
                    return false;
                }

                let storageError = null;
                try {
                    await storage.ref(`manuals/${manualName}`).delete();
                } catch (error) {
                    if (error?.code !== 'storage/object-not-found') {
                        storageError = error;
                        console.error("Storage delete error:", error);
                    }
                }

                if (state.currentManual === manualName) {
                    state.currentManual = '__ALL__';
                    highlightManual('__ALL__');
                    updateChatUI();
                }

                if (storageError) {
                    addMessage('system', `${manualName} was removed, but deleting the source file reported: ${storageError.message || storageError.code}.`);
                    return false;
                }

                addMessage('system', `${manualName} was deleted successfully.`);
                return true;
            }
            
            function updateChatUI() {
                 const hasKnowledge = !!state.aggregateManualText;
                const canChat = hasKnowledge && !state.isAwaitingResponse;
                chatInput.disabled = !canChat;
                sendButton.disabled = !canChat;

                if (!hasKnowledge) {
                    chatHeader.innerHTML = `<h2 class="text-xl font-semibold">Upload a manual to start chatting</h2>`;
                    chatInput.placeholder = 'Please upload a PDF manual first.';
                    return;
                }

                if (!state.currentManual || state.currentManual === '__ALL__') {
                    chatHeader.innerHTML = `<h2 class="text-xl font-semibold">Chatting with all manuals</h2>`;
                    chatInput.placeholder = 'Ask a question about any uploaded manual.';
                } else {
                    chatHeader.innerHTML = `<h2 class="text-xl font-semibold truncate">${state.currentManual}</h2>`;
                    chatInput.placeholder = `Ask a question about ${state.currentManual}`;
                }
            }

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const query = chatInput.value.trim();
                const hasKnowledge = !!state.aggregateManualText;
                if (!state.isApproved) return;
                if (!query || !hasKnowledge || state.isAwaitingResponse) return;
                
                if (state.isAdmin && !state.settings.apiKey) {
                    addMessage('system', 'Admin: Please add a Gemini API Key in Settings before chatting.');
                    return;
                }

                state.currentQuery = query;
                addMessage('user', query);
                chatInput.value = '';
                state.isAwaitingResponse = true;
                updateChatUI();
                addTypingIndicator();

                try {
                    const response = await queryGemini(query);
                    addMessage('assistant', response);
                } catch (error) {
                    console.error("Error querying Gemini:", error);
                    const readableError = error?.message || "Sorry, I couldn't get a response from the AI service.";
                    addMessage('system', readableError);
                } finally {
                    removeTypingIndicator();
                    state.isAwaitingResponse = false;
                    updateChatUI();
                    chatInput.focus();
                }
            });

            function addMessage(sender, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start space-x-3 max-w-xl`;
                const messageId = `msg-${Date.now()}`;
                
                let iconHtml, bubbleClass;

                if (sender === 'user') {
                    messageDiv.classList.add('ml-auto', 'justify-end');
                    bubbleClass = 'bg-blue-600 text-white';
                    iconHtml = `<div class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold text-sm shrink-0">YOU</div>`;
                    messageDiv.innerHTML = `<div class="p-3 rounded-lg ${bubbleClass}"><p class="text-sm">${content}</p></div>${iconHtml}`;
                } else if (sender === 'assistant') {
                    bubbleClass = 'bg-gray-700 text-gray-200';
                    iconHtml = `<div class="w-8 h-8 rounded-full bg-teal-600 flex items-center justify-center font-bold text-sm shrink-0">AI</div>`;
                    
                    let actionButtons = `
                        <div class="action-buttons mt-2 pt-2 border-t border-gray-600 flex items-center space-x-4">
                            <div class="feedback-buttons flex items-center space-x-2">
                                <button class="feedback-btn" data-feedback="up" data-message-id="${messageId}" title="Helpful"><svg class="w-4 h-4 text-gray-400 hover:text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 18.333V9a2 2 0 012-2h2.586a1 1 0 01.707.293l2.414 2.414a1 1 0 00.707.293h3.293z"></path></svg></button>
                                <button class="feedback-btn" data-feedback="down" data-message-id="${messageId}" title="Not Helpful"><svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14H5.236a2 2 0 01-1.789-2.894l3.5-7A2 2 0 018.738 3h4.017c.163 0 .326.02.485.06L17 5.667V15a2 2 0 01-2 2h-2.586a1 1 0 01-.707-.293l-2.414-2.414a1 1 0 00-.707-.293H6.707z"></path></svg></button>
                            </div>
                            <button class="escalate-btn flex items-center space-x-1 text-xs text-gray-400 hover:text-yellow-400" title="Escalate to expert"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg><span>Escalate</span></button>
                        </div>`;
                    let messageBody = `<div class="short-answer text-sm">${content.short}</div>`;
                    if (content.detailed) {
                        messageBody += `<div class="detailed-answer hidden mt-2 pt-2 border-t border-gray-600 text-sm">${content.detailed}</div><button class="expand-button text-blue-400 text-xs font-semibold mt-2 hover:underline">Show More</button>`;
                    }
                    if (state.currentQuery) messageBody += actionButtons;
                    messageDiv.innerHTML = `${iconHtml}<div class="p-3 rounded-lg ${bubbleClass} w-full" data-full-answer='${JSON.stringify(content)}'>${messageBody}</div>`;
                } else { // System messages
                    messageDiv.classList.add('mx-auto', 'justify-center');
                    bubbleClass = 'bg-yellow-800 text-white';
                    iconHtml = `<div class="w-8 h-8 rounded-full bg-yellow-600 flex items-center justify-center font-bold text-sm shrink-0">!</div>`;
                    messageDiv.innerHTML = `${iconHtml}<div class="p-3 rounded-lg ${bubbleClass}"><p class="text-sm">${content}</p></div>`;
                }
                chatMessages.appendChild(messageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            
            chatMessages.addEventListener('click', (e) => {
                const expandButton = e.target.closest('.expand-button');
                const feedbackButton = e.target.closest('.feedback-btn');
                const escalateButton = e.target.closest('.escalate-btn');

                if (expandButton) {
                    const detailedAnswer = expandButton.parentElement.querySelector('.detailed-answer');
                    if (detailedAnswer) detailedAnswer.classList.remove('hidden');
                    expandButton.style.display = 'none';
                } else if (feedbackButton) {
                    const messageId = feedbackButton.dataset.messageId;
                    const feedbackType = feedbackButton.dataset.feedback;
                    const messageBubble = feedbackButton.closest('[data-full-answer]');
                    const fullAnswer = JSON.parse(messageBubble.dataset.fullAnswer);
                    saveFeedback(messageId, state.currentQuery, fullAnswer, feedbackType);
                    
                    const parent = feedbackButton.parentElement;
                    Array.from(parent.children).forEach(btn => btn.classList.remove('selected', 'text-green-500', 'text-red-500'));
                    feedbackButton.classList.add('selected', feedbackType === 'up' ? 'text-green-500' : 'text-red-500');
                } else if (escalateButton) {
                     if (!state.settings.operatorEmail || state.settings.operatorEmail.trim() === '') {
                        addMessage('system', 'Escalation email is not configured. Please contact the administrator.');
                        return;
                    }
                    const messageBubble = escalateButton.closest('[data-full-answer]');
                    const fullAnswer = JSON.parse(messageBubble.dataset.fullAnswer);
                    const manualLabel = state.currentManual === '__ALL__' ? 'All Manuals' : state.currentManual;
                    const subject = encodeURIComponent(`Escalated Query: ${manualLabel}`);
                    const body = encodeURIComponent(`Manual Context: ${manualLabel}\nQuery: ${state.currentQuery}\n\nAI Answer: ${fullAnswer.short.replace(/<br>/g, '\n')}\n\nUser: ${state.user.email}`);
                    const mailtoLink = `mailto:${state.settings.operatorEmail}?subject=${subject}&body=${body}`;
                    window.open(mailtoLink, '_blank');
                    addMessage('system', 'Escalation email has been prepared in a new tab.');
                }
            });
            
            async function saveFeedback(messageId, query, answer, rating) {
                const manualTag = state.currentManual === '__ALL__' ? 'ALL_MANUALS' : (state.currentManual || 'UNKNOWN');
                await db.collection("feedback").add({
                    userId: state.user.uid,
                    query,
                    answer,
                    rating,
                    manual: manualTag,
                    timestamp: new Date()
                });
            }
            
            function listenForAnalytics() {
                if (!state.isAdmin || state.unsubscribeAnalytics) return;
                const q = db.collection("feedback");
                state.unsubscribeAnalytics = q.onSnapshot((snapshot) => {
                    renderAnalytics(snapshot.docs.map(doc => doc.data()));
                }, (error) => {
                    console.error("Error listening for analytics:", error);
                    addMessage('system', "Could not load analytics data.");
                });
            }

            analyticsButton.addEventListener('click', () => analyticsModal.classList.remove('hidden'));
            closeAnalyticsModal.addEventListener('click', () => analyticsModal.classList.add('hidden'));

            manageUsersButton.addEventListener('click', () => {
                if (!state.isAdmin) return;
                usersModal.classList.remove('hidden');
                loadUserAccounts();
            });
            closeUsersModal.addEventListener('click', () => {
                usersModal.classList.add('hidden');
                usersContent.innerHTML = '';
            });

            function renderAnalytics(entries) {
                if (entries.length === 0) {
                    analyticsContent.innerHTML = `<p class="text-gray-400">No feedback recorded yet.</p>`; return;
                }
                const upvotes = entries.filter(e => e.rating === 'up').length;
                const downvotes = entries.filter(e => e.rating === 'down').length;
                const total = entries.length;
                const satisfaction = total > 0 ? ((upvotes / total) * 100).toFixed(1) : 0;
                let html = `<div class="grid grid-cols-3 gap-4 mb-6 text-center"><div><p class="text-3xl font-bold text-green-500">${upvotes}</p><p class="text-sm text-gray-400">Helpful</p></div><div><p class="text-3xl font-bold text-red-500">${downvotes}</p><p class="text-sm text-gray-400">Not Helpful</p></div><div><p class="text-3xl font-bold text-blue-500">${satisfaction}%</p><p class="text-sm text-gray-400">Satisfaction</p></div></div><h3 class="text-lg font-semibold mb-3 text-white">Feedback Log</h3><div class="space-y-4">`;
                entries.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis()).forEach(entry => {
                    html += `<div class="p-3 rounded-lg ${entry.rating === 'up' ? 'bg-green-900/50' : 'bg-red-900/50'}"><p class="text-xs text-gray-500 mb-1">${entry.timestamp.toDate().toLocaleString()} by ${entry.userId.substring(0,6)}...</p><p class="font-semibold text-gray-300">Q: ${entry.query}</p><p class="text-sm text-gray-400 mt-1">A: ${entry.answer.short}</p></div>`;
                });
                analyticsContent.innerHTML = html + `</div>`;
            }

            async function loadUserAccounts() {
                if (!state.isAdmin) return;
                usersContent.innerHTML = '<p class="text-gray-400 py-2">Loading users...</p>';
                try {
                    const listUsersCallable = functions.httpsCallable('listUsers');
                    const result = await listUsersCallable();
                    const users = Array.isArray(result?.data?.users) ? result.data.users : [];
                    users.sort((a, b) => {
                        const emailA = (a.email || '').toLowerCase();
                        const emailB = (b.email || '').toLowerCase();
                        if (a.isAdmin !== b.isAdmin) return a.isAdmin ? -1 : 1;
                        if (a.approved !== b.approved) return a.approved ? -1 : 1;
                        return emailA.localeCompare(emailB);
                    });
                    state.users = users;
                    renderUserAccounts();
                } catch (error) {
                    console.error('Error loading users:', error);
                    const message = error?.message || 'Unknown error.';
                    usersContent.innerHTML = `<p class="text-red-400 py-2">Failed to load user accounts. ${message}</p>`;
                }
            }

            function renderUserAccounts() {
                usersContent.innerHTML = '';
                if (!Array.isArray(state.users) || state.users.length === 0) {
                    usersContent.innerHTML = '<p class="text-gray-400 py-4">No user accounts found.</p>';
                    return;
                }

                const currentUid = state.user?.uid;
                const fragment = document.createDocumentFragment();

                state.users.forEach((user) => {
                    const row = document.createElement('div');
                    row.className = 'py-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 text-sm';

                    const detail = document.createElement('div');
                    const email = user.email || '(no email)';
                    const badges = [];
                    if (user.isAdmin) badges.push('<span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-amber-500/20 text-amber-200">Admin</span>');
                    if (user.uid === currentUid) badges.push('<span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-blue-500/20 text-blue-200">You</span>');
                    const approvalBadge = user.approved
                        ? '<span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-green-500/20 text-green-300">Approved</span>'
                        : '<span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-yellow-500/20 text-yellow-100">Pending</span>';
                    const statusBadge = user.disabled ? '<span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-red-500/20 text-red-300">Disabled</span>' : '';
                    detail.innerHTML = `
                        <p class="font-medium text-gray-200 flex items-center flex-wrap">${email}${badges.join('')}${approvalBadge}${statusBadge}</p>
                        <p class="text-xs text-gray-500 break-all">UID: ${user.uid}</p>
                        <p class="text-xs text-gray-500">Created: ${formatTimestamp(user.creationTime)} | Last sign-in: ${formatTimestamp(user.lastSignInTime)}</p>
                    `;
                    row.appendChild(detail);

                    const actions = document.createElement('div');
                    actions.className = 'flex items-center space-x-2 shrink-0';

                    if (user.uid === currentUid) {
                        const note = document.createElement('span');
                        note.className = 'text-xs text-gray-500';
                        note.textContent = 'Current session';
                        actions.appendChild(note);
                    } else {
                        const approvalBtn = document.createElement('button');
                        approvalBtn.className = user.approved
                            ? 'px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-xs text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500'
                            : 'px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-xs text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500';
                        approvalBtn.textContent = user.approved ? 'Revoke Approval' : 'Approve';
                        approvalBtn.addEventListener('click', () => updateUserApprovalStatus(user, !user.approved, approvalBtn));
                        actions.appendChild(approvalBtn);

                        const toggleBtn = document.createElement('button');
                        toggleBtn.className = 'px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-xs text-gray-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500';
                        toggleBtn.textContent = user.disabled ? 'Enable' : 'Disable';
                        toggleBtn.addEventListener('click', () => updateUserDisabledStatus(user, !user.disabled, toggleBtn));
                        actions.appendChild(toggleBtn);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-xs text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500';
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.addEventListener('click', () => handleUserDeletion(user, deleteBtn));
                        actions.appendChild(deleteBtn);
                    }

                    row.appendChild(actions);
                    fragment.appendChild(row);
                });

                usersContent.appendChild(fragment);
            }

            async function updateUserDisabledStatus(user, disabled, triggerButton) {
                if (!state.isAdmin) return;
                if (triggerButton) triggerButton.disabled = true;
                try {
                    const callable = functions.httpsCallable('setUserDisabledStatus');
                    await callable({ uid: user.uid, disabled });
                    addMessage('system', `${user.email || user.uid} was ${disabled ? 'disabled' : 'enabled'}.`);
                    await loadUserAccounts();
                } catch (error) {
                    console.error('Error updating user status:', error);
                    const message = error?.message || 'Unknown error updating user status.';
                    addMessage('system', message);
                    if (triggerButton) triggerButton.disabled = false;
                }
            }

            async function updateUserApprovalStatus(user, approved, triggerButton) {
                if (!state.isAdmin) return;
                if (triggerButton) triggerButton.disabled = true;
                try {
                    const callable = functions.httpsCallable('setUserApprovalStatus');
                    await callable({ uid: user.uid, approved });
                    addMessage('system', `${user.email || user.uid} approval ${approved ? 'granted' : 'revoked'}.`);
                    await loadUserAccounts();
                } catch (error) {
                    console.error('Error updating user approval:', error);
                    const message = error?.message || 'Unknown error updating user approval.';
                    addMessage('system', message);
                    if (triggerButton) triggerButton.disabled = false;
                }
            }

            async function handleUserDeletion(user, triggerButton) {
                if (!state.isAdmin) return;
                if (!confirm(`Permanently delete ${user.email || user.uid}? This cannot be undone.`)) {
                    return;
                }
                if (triggerButton) triggerButton.disabled = true;
                try {
                    const callable = functions.httpsCallable('deleteUser');
                    await callable({ uid: user.uid });
                    addMessage('system', `${user.email || user.uid} was deleted.`);
                    await loadUserAccounts();
                } catch (error) {
                    console.error('Error deleting user:', error);
                    const message = error?.message || 'Unknown error deleting user.';
                    addMessage('system', message);
                    if (triggerButton) triggerButton.disabled = false;
                }
            }
            
            async function queryGemini(userQuery) {
                let manualText = '';
                if (state.currentManual === '__ALL__' || !state.currentManual) {
                    manualText = state.aggregateManualText;
                } else {
                    manualText = state.manuals[state.currentManual];
                }
                if (!manualText) throw new Error("Please upload a manual before asking a question.");

                // Use the callable function instead of a raw fetch
                const queryGeminiFunction = functions.httpsCallable('queryGemini');

                try {
                    const result = await queryGeminiFunction({
                      manualText,
                      userQuery,
                    });
                    return result.data;
                } catch (error) {
                    console.error("Cloud Function error:", error);
                    // Provide more specific feedback to the user
                    if (error.code === 'functions/unavailable') {
                        throw new Error("Cannot connect to the AI service. Please check your internet connection.");
                    }
                    throw new Error(error.message || "An unknown error occurred while contacting the AI service.");
                }
            }
            
            function addTypingIndicator() {
                const indicatorDiv = document.createElement('div');
                indicatorDiv.id = 'typing-indicator';
                indicatorDiv.className = 'flex items-start space-x-3 max-w-xl';
                indicatorDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-teal-600 flex items-center justify-center font-bold text-sm shrink-0">AI</div><div class="p-3 rounded-lg bg-gray-700"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
                chatMessages.appendChild(indicatorDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
            function removeTypingIndicator() {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
            }
        });
    </script>
</body>
</html>